# ĐỀ BÀN DỰ ÁN: XÂY DỰNG HỆ THỐNG DỊCH VỤ QUẢN TRỊ ĐẠI LÝ (AGENT MANAGEMENT SERVICE) – PHIÊN BẢN CHUẨN HÓA

**Tác giả:** Manus AI  
**Ngày:** 20 tháng 8 năm 2025

---

## Mục lục

1.  [Giới thiệu Dự án](#1-giới-thiệu-dự-án)
    1.1. [Bối cảnh và Động lực](#11-bối-cảnh-và-động-lực)  
    1.2. [Mục tiêu Dự án](#12-mục-tiêu-dự-án)  
    1.3. [Phạm vi Dự án](#13-phạm-vi-dự-án)
2.  [Yêu cầu Kỹ thuật và Công nghệ](#2-yêu-cầu-kỹ-thuật-và-công-nghệ)
    2.1. [Yêu cầu Chức năng](#21-yêu-cầu-chức-năng)  
    2.2. [Yêu cầu Phi chức năng](#22-yêu-cầu-phi-chức-năng)  
    2.3. [Công nghệ Sử dụng](#23-công-nghệ-sử-dụng)
3.  [Kiến trúc và Thiết kế Hệ thống](#3-kiến-trúc-và-thiết-kế-hệ-thống)
    3.1. [Tổng quan Kiến trúc](#31-tổng-quan-kiến-trúc)  
    3.2. [Thiết kế Backend (Agent Management Service)](#32-thiết-kế-backend-agent-management-service)
4.  [Hạ tầng và DevOps](#4-hạ-tầng-và-devops)
    4.1. [Môi trường Phát triển](#41-môi-trường-phát-triển)  
    4.2. [CI/CD Pipeline](#42-cicd-pipeline)  
    4.3. [Giám sát và Ghi log](#43-giám-sát-và-ghi-log)
5.  [Phát triển Backend (Agent Management Service)](#5-phát-triển-backend-agent-management-service)
    5.1. [Thiết kế Database](#51-thiết-kế-database)  
    5.2. [Phát triển API Quản lý Đại lý](#52-phát-triển-api-quản-lý-đại-lý)  
    5.3. [Xử lý Logic Quản lý và Tích hợp](#53-xử-lý-logic-quản-lý-và-tích-hợp)
6.  [Kiểm thử và Đảm bảo Chất lượng](#6-kiểm-thử-và-đảm-bảo-chất-lượng)
    6.1. [Unit Testing](#61-unit-testing)  
    6.2. [Integration Testing](#62-integration-testing)  
    6.3. [End-to-End Testing](#63-end-to-end-testing)
7.  [Triển khai và Vận hành](#7-triển-khai-và-vận-hành)
    7.1. [Triển khai Production](#71-triển-khai-production)  
    7.2. [Mở rộng và Khả năng sẵn sàng cao](#72-mở-rộng-và-khả-năng-sẵn-sàng-cao)  
    7.3. [Sao lưu và Phục hồi](#73-sao-lưu-và-phục-hồi)
8.  [Quản lý Dự án và Tài liệu hóa](#8-quản-lý-dự-án-và-tài-liệu-hóa)
    8.1. [Quản lý Phiên bản](#81-quản-lý-phiên-bản)  
    8.2. [Quản lý Vấn đề](#82-quản-lý-vấn-đề)  
    8.3. [Tài liệu Dự án](#83-tài-liệu-dự-án)

---

## 1. Giới thiệu Dự án

### 1.1. Bối cảnh và Động lực

Trong hệ sinh thái microservice, Agent Management Service là dịch vụ chuyên biệt, tập trung quản lý toàn bộ thông tin và hoạt động của các đại lý trong hệ thống. Việc tách biệt logic này giúp đảm bảo tính nhất quán, minh bạch và dễ bảo trì khi các quy tắc quản lý đại lý thay đổi, đồng thời cho phép các dịch vụ khác như Payment Service, Agent Policy Service truy vấn và quản lý thông tin đại lý một cách đồng bộ thông qua API Gateway.

### 1.2. Mục tiêu Dự án

Mục tiêu là phát triển một microservice backend độc lập "Agent Management Service" để:
-   Xử lý toàn bộ logic quản lý thông tin đại lý: đăng ký, cập nhật, phê duyệt, vô hiệu hóa và theo dõi hoạt động.
-   Cung cấp API RESTful an toàn, hiệu suất cao cho các dịch vụ khác (Payment Service, Agent Policy Service, Admin Service) truy vấn thông qua API Gateway.
-   Hỗ trợ đa dạng các loại đại lý (cá nhân, doanh nghiệp) và các cấp độ phân quyền khác nhau.
-   Tích hợp với Botpress Chatbot Service để hỗ trợ tự động hóa quy trình quản lý đại lý.
-   Đảm bảo khả năng mở rộng, vận hành ổn định với DevOps/CI-CD.

### 1.3. Phạm vi Dự án

-   **Backend Service (FastAPI, Python):**
    -   API RESTful cho quản lý (CRUD) và truy vấn thông tin đại lý.
    -   Logic xử lý quy trình đăng ký, phê duyệt và quản lý trạng thái đại lý.
    -   Tích hợp Message Broker để phát sự kiện khi thông tin đại lý thay đổi.
    -   Tích hợp với Botpress Chatbot Service để hỗ trợ tự động hóa.
-   **Infrastructure & DevOps:**
    -   Container hóa backend bằng Docker.
    -   Môi trường phát triển cục bộ với Docker Compose.
    -   CI/CD tự động hóa kiểm thử và triển khai cho backend.
    -   Giám sát và ghi log tập trung.

Lưu ý: Giao diện quản lý đại lý được đặt trong Agent Admin Frontend (tài liệu riêng) và tương tác với Agent Management Service qua API Gateway. Client Frontend và Agent Portal cũng có thể truy cập một số thông tin đại lý thông qua API Gateway.

---

## 2. Yêu cầu Kỹ thuật và Công nghệ

### 2.1. Yêu cầu Chức năng

-   **Quản lý Đại lý:** CRUD thông tin đại lý, phê duyệt/từ chối đăng ký, kích hoạt/vô hiệu hóa tài khoản, tìm kiếm/lọc đại lý.
-   **Quản lý Hồ sơ:** Lưu trữ và quản lý hồ sơ, tài liệu của đại lý (CMND/CCCD, giấy phép kinh doanh, v.v.).
-   **Theo dõi Hoạt động:** Ghi nhận và theo dõi các hoạt động của đại lý trong hệ thống.
-   **Phân cấp Đại lý:** Hỗ trợ cấu trúc phân cấp đại lý (đại lý cấp 1, cấp 2, v.v.).
-   **Tích hợp Chatbot:** Kết nối với Botpress để hỗ trợ tự động hóa quy trình và tương tác với đại lý.
-   **Báo cáo và Thống kê:** Cung cấp API để tạo báo cáo về hoạt động và hiệu suất của đại lý.

### 2.2. Yêu cầu Phi chức năng

-   **Bảo mật:** Giao tiếp qua HTTPS. Ủy quyền qua JWT từ Authify, được API Gateway kiểm tra và chuyển tiếp. Mã hóa thông tin nhạy cảm. Ghi log đầy đủ các thay đổi.
-   **Hiệu suất:** API truy vấn thông tin đại lý phải phản hồi nhanh (< 100ms). Hỗ trợ phân trang cho danh sách lớn.
-   **Độ tin cậy:** Đảm bảo tính toàn vẹn và nhất quán của dữ liệu đại lý. Backup định kỳ.
-   **Khả năng mở rộng:** Xử lý số lượng lớn đại lý và yêu cầu truy vấn đồng thời.
-   **Đồng bộ hóa:** Phát sự kiện qua Message Broker khi thông tin đại lý thay đổi.
-   **Tuân thủ:** Đảm bảo tuân thủ các quy định về bảo vệ dữ liệu cá nhân (GDPR, PDPA).

### 2.3. Công nghệ Sử dụng

-   **Backend:** Python 3.11+, FastAPI, SQLAlchemy, Pydantic.
-   **Database:** PostgreSQL với các extension cho full-text search.
-   **File Storage:** MinIO hoặc AWS S3 cho lưu trữ tài liệu đại lý.
-   **Chatbot Integration:** Botpress SDK/API.
-   **DevOps:** Docker, Docker Compose, GitHub Actions, Prometheus, Grafana.
-   **Message Broker:** Apache Kafka hoặc RabbitMQ.
-   **Security:** bcrypt cho hash password, JWT cho authentication.

---

## 3. Kiến trúc và Thiết kế Hệ thống

### 3.1. Tổng quan Kiến trúc

Agent Management Service là một microservice độc lập trong hệ sinh thái. Mọi yêu cầu từ bên ngoài đều phải đi qua API Gateway. API Gateway chịu trách nhiệm xác thực, ủy quyền, và định tuyến đến Agent Management Service.

```mermaid
graph TD
    ClientFE(Client Frontend) --> APIGW(API Gateway)
    AdminFE(Admin Frontend) --> APIGW
    AgentPortal(Agent Portal) --> APIGW
    AgentAdminFE(Agent Admin Frontend) --> APIGW
    PaymentService(Payment Service) --> APIGW
    AgentPolicyService(Agent Policy Service) --> APIGW
    BotpressService(Botpress Chatbot Service) --> APIGW
    APIGW -- "Định tuyến/Ủy quyền" --> AgentMgmtBackend(Agent Management Service)
    AgentMgmtBackend -- "DB" --> PostgreSQL[(PostgreSQL)]
    AgentMgmtBackend -- "File Storage" --> MinIO[(MinIO/S3)]
    AgentMgmtBackend -- "Sự kiện" --> MessageBroker[(Message Broker)]
    AgentMgmtBackend -- "Chatbot API" --> BotpressService
    
    subgraph "Frontend Applications"
        ClientFE
        AdminFE
        AgentPortal
        AgentAdminFE
    end
    
    subgraph "Backend Microservices"
        AgentMgmtBackend
        PaymentService
        AgentPolicyService
        BotpressService
        Authify(Authify Service)
    end
```

**Mô tả các thành phần chính:**

*   **Client Frontend:** Giao diện chính cho người dùng cuối, có thể xem thông tin cơ bản về đại lý.
*   **Admin Frontend:** Giao diện quản trị chính cho quản trị viên hệ thống, cho phép quản lý toàn bộ đại lý.
*   **Agent Portal:** Giao diện dành cho đại lý, cho phép đăng ký, cập nhật thông tin và theo dõi hoạt động.
*   **Agent Admin Frontend:** Giao diện quản trị dành cho quản lý đại lý cấp cao, cho phép phê duyệt và quản lý đại lý cấp dưới.
*   **Agent Management Service:** Dịch vụ backend chính xử lý tất cả logic quản lý đại lý.
*   **Botpress Chatbot Service:** Dịch vụ chatbot thông minh hỗ trợ tự động hóa quy trình và tương tác với đại lý.
*   **API Gateway:** Điểm truy cập duy nhất, xử lý xác thực, ủy quyền và định tuyến.

### 3.2. Thiết kế Backend (Agent Management Service)

-   **API Endpoints chính:**
    -   `/api/v1/agents`: (GET, POST) Lấy danh sách hoặc tạo mới đại lý.
    -   `/api/v1/agents/{agent_id}`: (GET, PUT, DELETE) Lấy chi tiết, cập nhật hoặc xóa đại lý.
    -   `/api/v1/agents/{agent_id}/approve`: (PUT) Phê duyệt đăng ký đại lý.
    -   `/api/v1/agents/{agent_id}/reject`: (PUT) Từ chối đăng ký đại lý.
    -   `/api/v1/agents/{agent_id}/activate`: (PUT) Kích hoạt tài khoản đại lý.
    -   `/api/v1/agents/{agent_id}/deactivate`: (PUT) Vô hiệu hóa tài khoản đại lý.
    -   `/api/v1/agents/{agent_id}/documents`: (GET, POST) Quản lý tài liệu của đại lý.
    -   `/api/v1/agents/{agent_id}/activities`: (GET) Lấy lịch sử hoạt động của đại lý.
    -   `/api/v1/agents/search`: (POST) Tìm kiếm đại lý theo các tiêu chí.
    -   `/api/v1/agents/hierarchy`: (GET) Lấy cấu trúc phân cấp đại lý.
    -   `/api/v1/agents/reports`: (GET) Tạo báo cáo về đại lý.
    -   `/api/v1/agents/chatbot/sync`: (POST) Đồng bộ thông tin với Botpress.

**Luồng xử lý chính:**

1. **Đăng ký Đại lý:** Agent Portal → API Gateway → Agent Management Service → Database
2. **Phê duyệt:** Admin Frontend → API Gateway → Agent Management Service → Message Broker (thông báo)
3. **Tích hợp Chatbot:** Agent Management Service ↔ Botpress Service (qua API Gateway)

---

## 4. Hạ tầng và DevOps

### 4.1. Môi trường Phát triển

-   **Docker Compose:** Định nghĩa môi trường phát triển cục bộ bao gồm:
    -   Agent Management Service
    -   PostgreSQL Database
    -   MinIO (Object Storage)
    -   Redis (Caching)
    -   Message Broker (Kafka/RabbitMQ)

### 4.2. CI/CD Pipeline

-   **GitHub Actions:** Tự động hóa quy trình:
    1. Code Quality Check (linting, formatting)
    2. Unit & Integration Testing
    3. Security Scanning
    4. Docker Image Build
    5. Push to Registry
    6. Deploy to Staging/Production

### 4.3. Giám sát và Ghi log

-   **Prometheus & Grafana:** Thu thập và trực quan hóa metrics:
    -   Số lượng đại lý theo trạng thái
    -   Thời gian phản hồi API
    -   Tỷ lệ lỗi
    -   Tài nguyên hệ thống
-   **ELK Stack/Loki:** Ghi log tập trung và phân tích:
    -   Application logs
    -   Audit logs
    -   Error tracking

---

## 5. Phát triển Backend (Agent Management Service)

### 5.1. Thiết kế Database

**Bảng chính:**

-   **`agents`:** Thông tin cơ bản của đại lý
    -   `id` (UUID, Primary Key)
    -   `user_id` (UUID, Foreign Key to Authify)
    -   `agent_code` (VARCHAR, Unique)
    -   `agent_type` (ENUM: individual, business)
    -   `status` (ENUM: pending, approved, rejected, active, inactive)
    -   `level` (INTEGER: 1, 2, 3...)
    -   `parent_agent_id` (UUID, Self-referencing)
    -   `personal_info` (JSONB)
    -   `business_info` (JSONB)
    -   `contact_info` (JSONB)
    -   `created_at`, `updated_at`, `approved_at`

-   **`agent_documents`:** Tài liệu của đại lý
    -   `id` (UUID, Primary Key)
    -   `agent_id` (UUID, Foreign Key)
    -   `document_type` (VARCHAR: id_card, business_license, etc.)
    -   `file_path` (VARCHAR)
    -   `file_name` (VARCHAR)
    -   `file_size` (BIGINT)
    -   `mime_type` (VARCHAR)
    -   `status` (ENUM: pending, verified, rejected)
    -   `uploaded_at`, `verified_at`

-   **`agent_activities`:** Lịch sử hoạt động
    -   `id` (UUID, Primary Key)
    -   `agent_id` (UUID, Foreign Key)
    -   `activity_type` (VARCHAR)
    -   `description` (TEXT)
    -   `metadata` (JSONB)
    -   `created_at`

-   **`agent_hierarchy`:** Cấu trúc phân cấp
    -   `id` (UUID, Primary Key)
    -   `parent_id` (UUID)
    -   `child_id` (UUID)
    -   `level_difference` (INTEGER)
    -   `created_at`

### 5.2. Phát triển API Quản lý Đại lý

-   **Cấu trúc Project:**
    ```
    agent_management_service/
    ├── app/
    │   ├── api/
    │   │   ├── v1/
    │   │   │   ├── endpoints/
    │   │   │   │   ├── agents.py
    │   │   │   │   ├── documents.py
    │   │   │   │   └── reports.py
    │   │   │   └── api.py
    │   │   └── deps.py
    │   ├── core/
    │   │   ├── config.py
    │   │   ├── security.py
    │   │   └── events.py
    │   ├── crud/
    │   │   ├── agent.py
    │   │   └── document.py
    │   ├── db/
    │   │   ├── base.py
    │   │   ├── session.py
    │   │   └── init_db.py
    │   ├── models/
    │   │   ├── agent.py
    │   │   └── document.py
    │   ├── schemas/
    │   │   ├── agent.py
    │   │   └── document.py
    │   ├── services/
    │   │   ├── agent_service.py
    │   │   ├── document_service.py
    │   │   ├── chatbot_service.py
    │   │   └── notification_service.py
    │   └── main.py
    ├── tests/
    ├── docker-compose.yml
    ├── Dockerfile
    └── requirements.txt
    ```

-   **Triển khai các API endpoint bằng FastAPI:**
    -   Sử dụng Pydantic để validation dữ liệu đầu vào/ra
    -   Implement pagination cho các endpoint trả về danh sách
    -   Xử lý upload/download file cho tài liệu đại lý
    -   API quản lý đại lý yêu cầu quyền admin hoặc agent_manager

### 5.3. Xử lý Logic Quản lý và Tích hợp

-   **Agent Service Logic:**
    -   Xử lý quy trình đăng ký đại lý (validation, tạo agent_code)
    -   Logic phê duyệt/từ chối với workflow
    -   Quản lý cấu trúc phân cấp đại lý
    -   Tính toán commission dựa trên cấp độ

-   **Document Service:**
    -   Upload tài liệu lên MinIO/S3
    -   Xác thực và phê duyệt tài liệu
    -   Tạo thumbnail cho hình ảnh

-   **Chatbot Integration:**
    -   Đồng bộ thông tin đại lý với Botpress
    -   Xử lý webhook từ Botpress
    -   Tự động hóa quy trình thông qua chatbot

-   **Event Publishing:**
    -   Phát sự kiện khi có thay đổi quan trọng:
        -   `agent_registered`
        -   `agent_approved`
        -   `agent_rejected`
        -   `agent_activated`
        -   `agent_deactivated`
        -   `document_uploaded`
        -   `document_verified`

---

## 6. Kiểm thử và Đảm bảo Chất lượng

### 6.1. Unit Testing

-   Kiểm thử các hàm logic trong services, crud, và utilities
-   Mock external dependencies (database, file storage, message broker)
-   Coverage target: > 90%

### 6.2. Integration Testing

-   Kiểm thử tương tác với database (PostgreSQL)
-   Kiểm thử tích hợp với file storage (MinIO)
-   Kiểm thử message broker integration
-   Kiểm thử API endpoints với test database

### 6.3. End-to-End Testing

-   Kiểm thử luồng hoàn chỉnh từ Frontend qua API Gateway đến Service
-   Kiểm thử tích hợp với Botpress
-   Performance testing với số lượng lớn đại lý

---

## 7. Triển khai và Vận hành

### 7.1. Triển khai Production

-   **Container Orchestration:** Kubernetes hoặc Docker Swarm
-   **Database:** PostgreSQL cluster với replication
-   **File Storage:** Distributed object storage (MinIO cluster hoặc AWS S3)
-   **Load Balancing:** Nginx hoặc HAProxy
-   **SSL/TLS:** Let's Encrypt hoặc corporate certificates

### 7.2. Mở rộng và Khả năng sẵn sàng cao

-   **Horizontal Scaling:** Multiple service instances behind load balancer
-   **Database Scaling:** Read replicas cho query-heavy operations
-   **Caching:** Redis cho frequently accessed data
-   **CDN:** CloudFlare hoặc AWS CloudFront cho static assets

### 7.3. Sao lưu và Phục hồi

-   **Database Backup:** Daily automated backups với retention policy
-   **File Storage Backup:** Cross-region replication
-   **Disaster Recovery:** RTO < 4 hours, RPO < 1 hour
-   **Backup Testing:** Monthly restore testing

---

## 8. Quản lý Dự án và Tài liệu hóa

### 8.1. Quản lý Phiên bản

-   **API Versioning:** Semantic versioning (v1.0.0, v1.1.0, v2.0.0)
-   **Database Migration:** Alembic cho schema changes
-   **Backward Compatibility:** Maintain compatibility for at least 2 major versions

### 8.2. Quản lý Vấn đề

-   **Issue Tracking:** GitHub Issues hoặc Jira
-   **Bug Reporting:** Structured templates với reproduction steps
-   **Feature Requests:** RFC process cho major features

### 8.3. Tài liệu Dự án

-   **API Documentation:** OpenAPI/Swagger với examples
-   **Architecture Documentation:** C4 model diagrams
-   **Deployment Guide:** Step-by-step deployment instructions
-   **Troubleshooting Guide:** Common issues và solutions
-   **Developer Guide:** Setup development environment

---

## Phụ lục

### A. Ví dụ API Request/Response

**Tạo đại lý mới:**
```json
POST /api/v1/agents
{
  "agent_type": "individual",
  "personal_info": {
    "full_name": "Nguyễn Văn A",
    "id_number": "123456789",
    "date_of_birth": "1990-01-01",
    "gender": "male"
  },
  "contact_info": {
    "phone": "+84901234567",
    "email": "agent@example.com",
    "address": "123 Main St, Ho Chi Minh City"
  }
}
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "agent_code": "AG001234",
  "status": "pending",
  "created_at": "2025-08-20T10:00:00Z",
  "message": "Agent registration submitted successfully"
}
```

### B. Database Schema Diagram

```mermaid
erDiagram
    agents {
        uuid id PK
        uuid user_id FK
        varchar agent_code UK
        enum agent_type
        enum status
        integer level
        uuid parent_agent_id FK
        jsonb personal_info
        jsonb business_info
        jsonb contact_info
        timestamp created_at
        timestamp updated_at
        timestamp approved_at
    }
    
    agent_documents {
        uuid id PK
        uuid agent_id FK
        varchar document_type
        varchar file_path
        varchar file_name
        bigint file_size
        varchar mime_type
        enum status
        timestamp uploaded_at
        timestamp verified_at
    }
    
    agent_activities {
        uuid id PK
        uuid agent_id FK
        varchar activity_type
        text description
        jsonb metadata
        timestamp created_at
    }
    
    agents ||--o{ agent_documents : has
    agents ||--o{ agent_activities : performs
    agents ||--o{ agents : manages
```

### C. Deployment Configuration

**docker-compose.production.yml:**
```yaml
version: '3.8'
services:
  agent-management-service:
    image: agent-management-service:latest
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/agentdb
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - postgres
      - redis
      - minio
      - kafka
    
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=agentdb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
  redis:
    image: redis:7-alpine
    
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data

volumes:
  postgres_data:
  minio_data:
```

Hệ thống Agent Management Service được thiết kế để đáp ứng đầy đủ các yêu cầu quản trị đại lý trong môi trường microservice hiện đại, với khả năng tích hợp cao và dễ dàng mở rộng.